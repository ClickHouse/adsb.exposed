<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="icon" href="favicon.png">
    <title>Planes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style type="text/css">
        :root {
            --progress: 0%;
            --progress-background-color1: #320;
            --progress-foreground-color1: #840;

            --progress-background-color2: #330;
            --progress-foreground-color2: #880;

            --progress-background-color3: #033;
            --progress-foreground-color3: #088;

            --progress-background-color: var(--progress-background-color3);
            --progress-foreground-color: var(--progress-foreground-color3);
        }
        * {
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        body {
            display: grid;
            grid-template-columns: auto;
            grid-template-rows: fit-content(10%) fit-content(2em) 1em auto;
            grid-gap: 0;
        }

        #query {
            width: 100%;
            min-width: 100%;
            max-width: 100vw;
            height: 4.5em;
            max-height: 50vh;
            margin: 0;
            padding: .5em;
            outline: none;
            border: none;
            background: #101213;
            color: lightgray;
            font-size: 14pt;
            border-bottom: 1px #333 solid;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #111;
            image-rendering: pixelated;
        }

        .leaflet-fade-anim .leaflet-popup {
            transition: none;
            font-family: monospace;
        }

        .leaflet-control-attribution {
            font-size: 12pt;
        }

        #error {
            display: none;
            position: absolute;
            z-index: 1001;
            bottom: max(5%, 1em);
            left: 50%;
            transform: translate(-50%, 0);
            background: #300;
            color: white;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 16pt;
            padding: 1em;
            min-width: 50%;
            max-width: 80%;
        }

        #stats {
            background: linear-gradient(to right,
                var(--progress-background-color) 0%,
                var(--progress-foreground-color) var(--progress),
                var(--progress-background-color) var(--progress));
            color: white;
            padding-right: .5em;
            font-family: monospace;
            text-align: right;
        }

        #examples {
            background: #202020;
            color: white;
            font-size: 12pt;
            font-family: monospace;
            padding: .125em .5em;
        }

        #examples span {
            display: inline-block;
            padding: .25em .5em;
            background: #444;
            user-select: none;
        }

        #examples span:hover {
            background: #840;
            cursor: pointer;
        }

        #examples span.selected {
            background: #666;
        }

        #layers, #provider {
            position: absolute;
            padding: .3em .5em .2em .5em;
            font-family: monospace;
            color: black;
            background: lightgray;
            box-shadow: 2px 2px 10px rgba(0,0,0,1);
            z-index: 1001;
            user-select: none;
        }

        #layers {
            left: 1em;
            bottom: 1em;
            width: 2em;
            height: 2em;
            padding: .3em .5em .2em .5em;
            font-size: 16pt;
            text-align: center;
            cursor: pointer;
        }

        #provider {
            left: 4em;
            bottom: 1em;
            height: 2em;
            padding: 0.1em .3em 0.1em 0.3em;
            font-size: 16pt;

        }

        #provider form {
            font-size: 12pt;
            color: #333;
        }

        #provider * {
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <textarea spellcheck="false" data-gramm="false" id="query"></textarea>
    <div id="examples">Examples:
        <span class="selected">Speed &amp; Velocity</span>
        <span>Boeing vs. Airbus</span>
        <span>Helicopters</span>
        <span>Hi-Performance</span>
        <span>Supersonic</span>
        <span>Light</span>
        <span>Gliders</span>
        <span>Military</span>
        <span>Vertical Speed</span>
        <span>Roll Angle</span>
        <span>Steep</span>
        <span>Year</span>
        <span>A380</span>
        <span>IL-76</span>
        <span>F-16</span>
        <span>KLM</span>
        <span>N2163J</span>
        <span>Event Time</span>
        <span>Weekends</span>
        <span>Elon Musk</span>
    </div>
    <div id="stats"></div>
    <div id="map"></div>
    <div id="error"></div>
    <div id="layers">üëÅ</div>

    <div id="provider">
        <form>
            <label>
                <input type="radio" name="provider" value="self-hosted" checked>
                Self-hosted
            </label>
            <br/>
            <label>
                <input type="radio" name="provider" value="cloud">
                Cloud
            </label>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let queries = {
"Speed & Velocity": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000000 DIV zoom_factor, count()) AS max_total,

    pow(total / max_total, 1/5) AS transparency,
    greatest(0, least(avg(altitude), 5000)) / 5000 AS color1,
    greatest(0, least(avg(altitude), 50000)) / 50000 AS color3,
    greatest(0, least(avg(ground_speed), 700)) / 700 AS color2,

    255 AS a,
    (1 + transparency) / 2 * (1 - color3) * 255 AS r,
    transparency * color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Boeing vs. Airbus": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    sum(desc LIKE 'BOEING%') AS boeing,
    sum(desc LIKE 'AIRBUS%') AS airbus,
    sum(NOT (desc LIKE 'BOEING%' OR desc LIKE 'AIRBUS%')) AS other,

    greatest(1000000 DIV zoom_factor, total) AS max_total,
    greatest(1000000 DIV zoom_factor, boeing) AS max_boeing,
    greatest(1000000 DIV zoom_factor, airbus) AS max_airbus,
    greatest(1000000 DIV zoom_factor, other) AS max_other,

    pow(total / max_total, 1/5) AS transparency,

    255 * (1 + transparency) / 2 AS a,
    pow(boeing, 1/5) * 256 DIV (1 + pow(max_boeing, 1/5)) AS r,
    pow(airbus, 1/5) * 256 DIV (1 + pow(max_airbus, 1/5)) AS g,
    pow(other, 1/5) * 256 DIV (1 + pow(max_other, 1/5)) AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Helicopters": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000000 DIV zoom_factor, count()) AS max_total,

    pow(total / max_total, 1/5) AS transparency,
    greatest(0, least(avg(altitude), 500)) / 500 AS color1,
    greatest(0, least(avg(altitude), 5000)) / 5000 AS color3,
    greatest(0, least(avg(ground_speed), 200)) / 200 AS color2,

    255 AS a,
    (1 + transparency) / 2 * (1 - color3) * 255 AS r,
    transparency * color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND aircraft_category = 'A7' AND ground_speed < 200
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Hi-Performance": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000000 DIV zoom_factor, total) AS max_total,

    pow(total / max_total, 1/5) AS transparency,

    0 AS r,
    255 AS g,
    255 AS b,

    255 * transparency AS a

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND aircraft_category = 'A6'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Supersonic": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    greatest(0, least(avg(altitude), 50000)) / 50000 AS color1,
    (greatest(0, least(avg(ground_speed), 1000)) - 666) / 334 AS color2,

    255 AS a,
    color2 * 255 AS r,
    color1 * 255 AS g,
    least(1, count() / 10) * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND ground_speed > 666
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Light": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000000 DIV zoom_factor, total) AS max_total,
    pow(total / max_total, 1/5) AS transparency,

    greatest(0, least(avg(altitude), 50000)) / 50000 AS color1,
    greatest(0, least(avg(ground_speed), 700)) / 700 AS color2,

    255 * transparency AS r,
    255 * color2 AS g,
    255 * color1 AS b,
    255 * (1/4 + 3/4 * transparency) AS a

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND aircraft_category = 'A1'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Vertical Speed": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    least(255, 2 * greatest(r, g)) AS a,
    255 * least(1, avg(greatest(0, vertical_rate)) / 5000) AS g,
    255 * least(1, avg(least(0, vertical_rate)) / -5000) AS r,
    0 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Roll Angle": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    255 * least(1, avg(abs(roll_angle)) / 10) AS a,
    255 * avg(max2(0, roll_angle)) / 21 AS r,
    255 * avg(min2(0, roll_angle)) / -21 AS g,
    (1 - a) AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Year": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000000 DIV zoom_factor, total) AS max_total,

    pow(total / max_total, 1/5) AS transparency,

    255 * transparency AS a,
    255 * avg(year < 2000) AS r,
    255 * avg(year >= 2010) AS g,
    a AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND year != 0
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"A380": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(100000 DIV zoom_factor, count()) AS max_total,

    pow(total / max_total, 1/5) AS transparency,
    greatest(0, least(avg(altitude), 5000)) / 5000 AS color1,
    greatest(0, least(avg(altitude), 50000)) / 50000 AS color3,
    greatest(0, least(avg(ground_speed), 700)) / 700 AS color2,

    255 AS a,
    (1 + transparency) / 2 * (1 - color3) * 255 AS r,
    transparency * color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND t = 'A388'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"IL-76": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    greatest(0, least(avg(altitude), 50000)) / 50000 AS color1,
    greatest(0, least(avg(ground_speed), 700)) / 700 AS color2,

    255 AS a,
    255 AS r,
    color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND t = 'IL76'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"F-16": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000 DIV zoom_factor, count()) AS max_total,
    pow(total / max_total, 1/5) AS transparency,

    greatest(0, least(avg(altitude), 50000)) / 50000 AS color1,
    greatest(0, least(avg(ground_speed), 700)) / 700 AS color2,

    transparency * 255 AS a,
    255 AS r,
    color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND t = 'F16'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"KLM": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(100000 DIV zoom_factor, count()) AS max_total,

    pow(total / max_total, 1/5) AS transparency,
    greatest(0, least(avg(altitude), 5000)) / 5000 AS color1,
    greatest(0, least(avg(altitude), 50000)) / 50000 AS color3,
    greatest(0, least(avg(ground_speed), 700)) / 700 AS color2,

    255 AS a,
    (1 + transparency) / 2 * (1 - color3) * 255 AS r,
    transparency * color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier} AS t
WHERE in_tile AND aircraft_flight LIKE 'KLM%'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"N2163J": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    max(total) OVER () AS max_total,

    pow(total / max_total, 1/5) AS transparency,
    greatest(0, least(avg(altitude), 5000)) / 5000 AS color1,
    greatest(0, least(avg(ground_speed), 100)) / 100 AS color2,

    255 AS a,
    transparency * 255 AS r,
    transparency * color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier} AS t
WHERE in_tile AND t.r = 'N2163J'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Gliders": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    max(total) OVER () AS max_total,
    pow(total / max_total, 1/5) AS transparency,

    greatest(0, least(avg(altitude), 5000)) / 5000 AS color1,
    greatest(0, least(avg(ground_speed), 100)) / 100 AS color2,

    255 * color2 AS b,
    255 * transparency * (color1 + color2) / 2 AS g,
    255 * (1 - color1) AS r,
    255 * (1 + transparency) / 2 AS a

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND aircraft_category = 'B1'
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Event Time": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    avg(time::Float64) AS offset,
    min(offset) OVER () AS min_offset,
    max(offset) OVER () AS max_offset,

    (1 + offset - min_offset) / (1 + max_offset - min_offset) AS rel_time,

    255 AS a,
    255 * rel_time AS g,
    255 * (1 - rel_time) AS r,
    0 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Weekends": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000000 DIV zoom_factor, count()) AS max_total,
    pow(total / max_total, 1/5) AS transparency,

    toDayOfWeek(date + INTERVAL lon / 15 HOUR) > 5 AS weekend,
    avg(weekend) AS c_weekend,
    avg(NOT weekend) AS c_weekday,

    c_weekend * 2.5 > c_weekday AS mostly_weekends,

    255 * transparency AS a,
    255 * c_weekend * mostly_weekends AS r,
    r / 2 AS g,
    255 * c_weekday * (NOT mostly_weekends) AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Elon Musk": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    transform(t.r, ['N628TS', 'N272BG', 'N502SX', 'N140FJ'], [0xFF8888, 0x88FF88, 0xAAAAFF, 0xFFFF00], 0) AS color,

    255 AS a,
    avg(color DIV 0x10000) AS r,
    avg(color DIV 0x100 MOD 0x100) AS g,
    avg(color MOD 0x100) AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier} AS t
WHERE in_tile AND t.r IN ('N628TS', 'N272BG', 'N502SX', 'N140FJ')
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Military": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(1000000 DIV zoom_factor, count()) AS max_total,

    pow(total / max_total, 1/5) AS transparency,
    greatest(0, least(avg(altitude), 5000)) / 5000 AS color1,
    greatest(0, least(avg(altitude), 50000)) / 50000 AS color3,
    greatest(0, least(avg(ground_speed), 700)) / 700 AS color2,

    255 AS a,
    (1 + transparency) / 2 * (1 - color3) * 255 AS r,
    transparency * color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND dbFlags = 1
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`,

"Steep": `WITH
    bitShiftLeft(1::UInt64, {z:UInt8}) AS zoom_factor,
    bitShiftLeft(1::UInt64, 32 - {z:UInt8}) AS tile_size,

    tile_size * {x:UInt16} AS tile_x_begin,
    tile_size * ({x:UInt16} + 1) AS tile_x_end,

    tile_size * {y:UInt16} AS tile_y_begin,
    tile_size * ({y:UInt16} + 1) AS tile_y_end,

    mercator_x >= tile_x_begin AND mercator_x < tile_x_end
    AND mercator_y >= tile_y_begin AND mercator_y < tile_y_end AS in_tile,

    bitShiftRight(mercator_x - tile_x_begin, 32 - 10 - {z:UInt8}) AS x,
    bitShiftRight(mercator_y - tile_y_begin, 32 - 10 - {z:UInt8}) AS y,

    y * 1024 + x AS pos,

    count() AS total,
    greatest(100000 DIV zoom_factor, count()) AS max_total,

    pow(total / max_total, 1/5) AS transparency,
    greatest(0, least(avg(altitude), 5000)) / 5000 AS color1,
    greatest(0, least(avg(altitude), 20000)) / 20000 AS color3,
    least(avg(abs(vertical_rate)), 10000) / 10000 AS color2,

    (1 + transparency) / 2 * 255 AS a,
    (1 + transparency) / 2 * (1 - color3) * 255 AS r,
    transparency * color1 * 255 AS g,
    color2 * 255 AS b

SELECT round(r)::UInt8, round(g)::UInt8, round(b)::UInt8, round(a)::UInt8
FROM {table:Identifier}
WHERE in_tile AND ground_speed > 0 AND ground_speed < 50 AND abs(vertical_rate) > 5000
GROUP BY pos ORDER BY pos WITH FILL FROM 0 TO 1024*1024`
        };

        let uuid = crypto.randomUUID();

        let base_layer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            zoomOffset: 0,
            minZoom: 2,
            maxZoom: 19,
            attribution: '¬© OpenStreetMap',
            opacity: 0.1,
        });

        let query_elem = document.getElementById('query');
        let map_elem = document.getElementById('map');

        function expandQueryEditor() {
            query_elem.style.height = query_elem.scrollHeight + 'px';
        }

        function collapseQueryEditor() {
            query_elem.style.height = '4.5em';

            let selected_example = document.querySelector('#examples .selected');
            if (selected_example && query_elem.value != queries[selected_example.textContent]) {
                selected_example.classList.remove('selected');
            }

            query_elem.blur();
            main_layer_sample100.redraw();
        }

        function setQuery(value) {
            query_elem.value = value;
            collapseQueryEditor();
        }

        for (elem of document.querySelectorAll('#examples span')) {
            elem.addEventListener('click', e => {
                for (other of document.querySelectorAll('#examples span')) {
                    other.classList.remove('selected');
                }
                e.target.classList.add('selected');
                setQuery(queries[e.target.textContent]);
            });
        }

        query_elem.addEventListener('input', expandQueryEditor);
        query_elem.addEventListener('focus', expandQueryEditor);
        map_elem.addEventListener('focus', collapseQueryEditor);

        query_elem.addEventListener('keydown', e => {
            /// Firefox has code 13 for Enter and Chromium has code 10.
            if ((event.metaKey || event.ctrlKey) && (event.keyCode == 13 || event.keyCode == 10)) {
                collapseQueryEditor();
            }
        });

        function getHost() {
            const provider = document.querySelector('input[name="provider"]:checked').value;
            return provider == 'self-hosted' ?
                'https://fly-selfhosted-backend.clickhouse.com' :
                'https://kvzqttvc2n.eu-west-1.aws.clickhouse-staging.com';
        }

        document.querySelector('form').addEventListener('change', e => {
            cached_tiles = {};
            main_layer_sample100.redraw();
        });

        let show_progress_bar = 0;

        async function render(table, coords, tile) {
            const sql = query_elem.value;
            const key = `${sql}-${table}-${coords.z}-${coords.x}-${coords.y}`;
            let buf = cached_tiles[key];
            if (!buf) {
                const query_id = `${uuid}-${table}-${coords.z - 2}-${coords.x}-${coords.y}`;
                const host = getHost();
                const url = `${host}/?user=website&default_format=RowBinary` +
                    `&query_id=${query_id}&replace_running_query=1` +
                    `&param_table=${table}` +
                    `&param_z=${coords.z - 2}&param_x=${coords.x}&param_y=${coords.y}`;

                show_progress_bar = 10;
                const response = await fetch(url, { method: 'POST', body: sql });

                if (!response.ok) {
                    const text = await response.text();
                    if (!text.includes('QUERY_WAS_CANCELLED') && !text.includes('QUERY_WITH_SAME_ID_IS_ALREADY_RUNNING')) {
                        let err = document.getElementById('error');
                        err.textContent = text;
                        err.style.display = 'block';
                    }
                    return;
                }

                buf = await response.arrayBuffer();
                cached_tiles[key] = buf;
            }

            let ctx = tile.getContext('2d');
            let image = ctx.createImageData(1024, 1024);
            let arr = new Uint8ClampedArray(buf);

            for (let i = 0; i < 1024 * 1024 * 4; ++i) { image.data[i] = arr[i]; }

            ctx.putImageData(image, 0, 0, 0, 0, 1024, 1024);

            let err = document.getElementById('error');
            err.style.display = 'none';

            console.log(Object.keys(cached_tiles).length);
        }

        let cached_tiles = {};

        L.GridLayer.ClickHouse = L.GridLayer.extend({
            createTile: function(coords, done) {
                let tile = L.DomUtil.create('canvas', 'leaflet-tile');
                tile.width = 1024;
                tile.height = 1024;
                render(this.options.table, coords, tile).then(err => done(err, tile));
                return tile;
            }
        });

        const layer_options = {
            tileSize: 1024,
            minZoom: 2,
            maxZoom: 19,
            minNativeZoom: 2,
            maxNativeZoom: 16,
            attribution: '¬© Alexey Milovidov, ClickHouse, Inc. (data: adsb.lol, adsbexchange.com)'
        };

        let layer_options_full = layer_options;
        layer_options_full.table = 'planes_mercator';
        let main_layer_full = new L.GridLayer.ClickHouse(layer_options_full);

        let layer_options_sample10 = layer_options;
        layer_options_sample10.table = 'planes_mercator_sample10';
        let main_layer_sample10 = new L.GridLayer.ClickHouse(layer_options_sample10);

        let layer_options_sample100 = layer_options;
        layer_options_sample100.table = 'planes_mercator_sample100';
        let main_layer_sample100 = new L.GridLayer.ClickHouse(layer_options_sample100);

        setQuery(queries[document.querySelector('#examples .selected').textContent]);

        let map = L.map('map', {
            center: [52.3676, 4.9041],
            zoom: 5,
            layers: [base_layer, main_layer_sample100]
        });

        main_layer_sample100.on('load', e => {
            main_layer_sample10.addTo(map);
            document.documentElement.style.setProperty('--progress-background-color', 'var(--progress-background-color2)');
            document.documentElement.style.setProperty('--progress-foreground-color', 'var(--progress-foreground-color2)');
        });

        main_layer_sample10.on('load', e => {
            main_layer_full.addTo(map);
            document.documentElement.style.setProperty('--progress-background-color', 'var(--progress-background-color3)');
            document.documentElement.style.setProperty('--progress-foreground-color', 'var(--progress-foreground-color3)');
        });

        main_layer_sample100.on('loading', e => {
            main_layer_full.removeFrom(map);
            main_layer_sample10.removeFrom(map);
            document.documentElement.style.setProperty('--progress-background-color', 'var(--progress-background-color1)');
            document.documentElement.style.setProperty('--progress-foreground-color', 'var(--progress-foreground-color1)');
        });

        map.attributionControl.setPrefix('<a href="https://github.com/ClickHouse/reversedns.space/">About</a>');

        let active_stat_queries = 0;
        async function getStats() {
            if (show_progress_bar <= 0 || active_stat_queries > 0) return;

            const sql = `SELECT
                    sum(read_rows) AS r,
                    sum(total_rows_approx) AS t,
                    sum(read_bytes) AS b,
                    r / max(elapsed) AS rps,
                    b / max(elapsed) AS bps,
                    formatReadableQuantity(r) AS formatted_rows,
                    formatReadableSize(b) AS formatted_bytes,
                    formatReadableQuantity(rps) AS formatted_rps,
                    formatReadableSize(bps) AS formatted_bps
                FROM clusterAllReplicas(default, system.processes)
                WHERE user = 'website' AND startsWith(query_id, {uuid:String})`;

            const host = getHost();
            const url = `${host}/?user=website&default_format=JSON&param_uuid=${uuid}`;

            ++active_stat_queries;
            let response;
            let data;
            try {
                response = await fetch(url, { method: 'POST', body: sql });
                data = await response.json();
            } catch (e) {}
            --active_stat_queries;

            const stat = data.data[0];

            if (stat.t && stat.t > 0) {
                document.documentElement.style.setProperty('--progress', (100 * stat.r / stat.t) + '%');

                let text = '';
                if (stat.r > 0) text += `Processed ${stat.formatted_rows} rows, ${stat.formatted_bytes}`;
                if (stat.rps > 100e6) text += ` (${stat.formatted_rps}/sec, ${stat.formatted_bps}/sec)`;

                document.getElementById('stats').textContent = text;
            } else {
                document.documentElement.style.setProperty('--progress', '0');
                --show_progress_bar;
            }
        }

        setInterval(getStats, 100);

        document.getElementById('layers').addEventListener('click', e => {
            const mode = base_layer.options.opacity < 0.5;

            if (mode) {
                base_layer.setOpacity(0.5);
                base_layer.bringToFront();
            } else {
                base_layer.setOpacity(0.1);
                base_layer.bringToBack();
            }
        });
    </script>
</body>
</html>
